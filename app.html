<!DOCTYPE html>
 
<html>
  <head>
    <meta charset="utf-8">
    <title>ボイド</title>
    <style>body{margin:0;padding:0;}</style>
    <script src="components/loader.js"></script>
    <link rel="stylesheet" href="components/loader.css">
    <link rel="stylesheet" href="css/style.css">
    <canvas id="world"></canvas>
    <script>
    var FPS = 30;                   // フレームレート
    var SCREEN_WIDTH = 600;          // 画面サイズ
    var SCREEN_HEIGHT = 400;
    var NUM_BOIDS = 300;            // ボイドの数
    var BOID_SIZE = 5;              // ボイドの大きさ
    var MAX_SPEED = 3.5;              // ボイドの最大速度
    var MIN_SPEED = 2;                  // ボイドの最小速度
    var fish = {                        // プレイヤの位置
            x : SCREEN_WIDTH / 2,
            y : SCREEN_HEIGHT / 2,
            vx : 0,
            vy : 0,
            };
    var SCORE = 0;    
    var canvas = document.getElementById('world');
    var ctx = canvas.getContext('2d');
    var boids = [];
    canvas.width = screen.height;
    canvas.height = SCREEN_HEIGHT;
    var ax
    var ay
    var text = "SCORE : " + SCORE;
    var time = 30;                  // 制限時間
    
    window.onload = function() {
        document.getElementById("2").style.visibility = "hidden";
        document.getElementById("3").style.visibility = "hidden";

        /* 初期化 */
        canvas.width = SCREEN_WIDTH;
        canvas.height = SCREEN_HEIGHT;
        ctx.fillStyle = "rgba(33, 33, 33, 0.8)"; // ボイドの色
        for (var i=0; i<NUM_BOIDS; ++i) {
            boids[i] = {
                x: Math.random()*canvas.width,          // x座標
                y: Math.random()*canvas.height,         // y座標
                vx: (Math.random() * 4) - 2,            // x方向の速度
                vy: (Math.random() * 4) - 2             // y方向の速度
                }
            }
            
    
        /* ループ開始 */
        var main = setInterval(simulate, 1000/FPS);
        var fishmove = setInterval(fishm, 1000/FPS);
        var count = setInterval(countdown, 100);
        setTimeout(function(){clearInterval(fishmove);}, time*1000);
        setTimeout(function(){clearInterval(main);}, time*1000);
        setTimeout(function(){clearInterval(count);}, time*1000);
        setTimeout(finish, time*1000);
        

    };
    
    
    /* プレイヤー操作 */
    var fishm =function() {
window.onmousemove = handleMouseMove;
         function handleMouseMove(event) {
            
            //重力加速度センサー
            ax = fish.x - event.clientX;
            ay = fish.y - event.clientY; 
        };
        
        /* プレイヤーの位置更新 */
        var fspeed = Math.sqrt(ax*ax + ay*ay);
            if (fspeed >= 8) {
                var q = 8 / fspeed;
                fish.vx = ay * q;
                fish.vy = ax * q;
            }
            if(fspeed < 8){
                fish.vx = ax*0.9;
                fish.vy = ay*0.9;
            }
            if(5<fish.x && fish.x<SCREEN_WIDTH-5){
                fish.x -= fish.vy/1.5;
                    
                }
                if(5>=fish.x){
                        fish.x += 1
                        }
                    if(fish.x>=SCREEN_WIDTH-5){
                        fish.x -= 1
                    }
                if(5<fish.y && fish.y<SCREEN_HEIGHT-5){
                    fish.y -= fish.vx/1.5;
                        
                    }
                    if(5>=fish.y){
                        fish.y += 1
                        }
                    if(fish.y>=SCREEN_HEIGHT-5){
                        fish.y -= 1
                }
    };
    
            /* カウントダウン */    
        var countdown = function(){
            time -= 0.1;    
            if(time < 0){　
            clearTimeout(count);　//idをclearTimeoutで指定している
    }
  };
            

        /* シミュレーション */
        var simulate = function() {
           
            
        draw();         // ボイドの描画
        move();         // ボイドの座標の更新
        
   
    };
    
    
        /**
         * ボイドの描画
         */
         
        var draw = function() {
                    
        
            ctx.clearRect(0, 0, SCREEN_WIDTH, SCREEN_HEIGHT); // 画面をクリア

            

          // 全てのボイドの描画
        for (var i=0,len=boids.length; i<len; ++i) {
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.lineCap = "butt";
            ctx.moveTo(boids[i].x, boids[i].y);
            ctx.lineTo(boids[i].x+boids[i].vx*2, boids[i].y+boids[i].vy*2);
            ctx.stroke();
            
        }
            
            var rad = -Math.atan2(fish.vy,fish.vx)+ 90* Math.PI / 180;
            ctx.beginPath();
            ctx.lineWidth = 8;
            ctx.lineCap = "round";
            ctx.moveTo(fish.x, fish.y);
            ctx.lineTo(fish.x + 8*Math.cos(rad), fish.y + 8*Math.sin(rad));
            ctx.stroke();
            
            text = "SCORE : " + SCORE;
            ctx.font = "24px Arial"; //フォントにArial,40px,斜体を指定
            ctx.fillStyle = "white"; //塗り潰し色を緑に
            ctx.fillText(text, 40 , 40, );
            

            ctx.font = "24px Arial"; //フォントにArial,40px,斜体を指定
            ctx.fillStyle = "white"; //塗り潰し色を緑に
            ctx.fillText(time.toFixed(1), 510 , 40, );
    };
    
    
    /**
     * ボイドの位置の更新
     */
    var move = function() {
        

        for (var i=0,len=boids.length; i<len; ++i) {
            // ルールを適用して速さを変更
            rule1(i);    // 近くの群れの真ん中に向かおうとする
            rule2(i);    // ボイドは他のボイドと距離を取ろうとする
            rule3(i);
            rule5(i);

            // limit speed
            var b = boids[i];
            var speed = Math.sqrt(b.vx*b.vx + b.vy*b.vy);
            if (speed >= 3) {
              if(fishd > 70){
                var r = 3 / speed;
                b.vx *= r;
                b.vy *= r;
                }else{
                  var r = 4 / speed;
                  b.vx *= r;
                  b.vy *= r;
                  
                }
            }
            if (speed <= MIN_SPEED) {
                var p = MIN_SPEED / speed;
                b.vx *= p;
                b.vy *= p;
            }
            // 壁の外に出てしまった場合速度を内側へ向ける
            if (b.x<60 && b.vx<0 || b.x>SCREEN_WIDTH && b.vx>0){
                if (b.vy > 0){
                b.vy += 0.01;
                b.vx += -0.01;}
                    else{
                    b.vy += -0.01;
                    b.vx += -0.01;}
                }
            if (b.x<10 && b.vx<0 || b.x>SCREEN_WIDTH && b.vx>0){
                    b.vx *= -1;
                }
            if (b.y<40 && b.vy<0 || b.y>SCREEN_HEIGHT && b.vy>0){
                if (b.vy > 0){
                b.vx += 0.01;
                b.vy += -0.01;}
                else{
                    b.vx += -0.01;
                    b.vy += -0.01;}
            }
        if (b.y<10 && b.vy<0 || b.y>SCREEN_HEIGHT && b.vy>0){
            b.vy *= -1;
            }
        // 座標の更新
        b.x += b.vx;
        b.y += b.vy;
        if (b.x){
            
        }

    }

};


/**
 * ルール1: ボイドは近くに存在する群れの中心に向かおうとする
 */
    var rule1 = function(index) {
        for (var i=0,len=boids.length; i<len; ++i) {
            if (i != index) {
                var d = getDistance(boids[i], boids[index]);
            if(d < 5 ){
                  boids[index].vx += (boids[i].vx-boids[index].vx) / 200;
                  boids[index].vy += (boids[i].vy-boids[index].vy) / 200;  
                }
            if(d < 18 && d > 5 ){
                  boids[index].vx += (boids[i].x-boids[index].x) / 100;
                  boids[index].vy += (boids[i].y-boids[index].y) / 100;
                }
            if(d < 22 && d > 5 ){
                boids[index].vx += (boids[i].vx-boids[index].vx) / 40;
                boids[index].vy += (boids[i].vy-boids[index].vy) / 40;  
              }
            }
        }
    };
    
    
    /*
     * ルール2: ボイドは隣のボイドとちょっとだけ距離をとろうとする
     */
    var rule2 = function(index) {
        for (var i=0,len=boids.length; i<len; ++i) {
            if (i != index) {
                var d = getDistance(boids[i], boids[index]); // ボイド間の距離
                if (d < 9) {
                    boids[index].vx -= (boids[i].x - boids[index].x) / 6;
                    boids[index].vy -= (boids[i].y - boids[index].y) / 6;
                }
            }
        }
    };
    
    
    var rule3 = function(index) {
        var randNum = Math.floor(Math.random()*(10));
        if(randNum == 1){
            boids[index].vx += (Math.random() * 2) - 1;
            boids[index].vy += (Math.random() * 2) - 1;
        }
    };
    

    /*
    *プレイヤーから逃げる
    */
    var rule5 = function(index) {
        for (var i=0,len=boids.length; i<len; ++i) {
        fishd = Math.sqrt((boids[index].x-fish.x)*(boids[index].x-fish.x) + (boids[index].y-fish.y)*(boids[index].y-fish.y));
        if (30 < fishd &&　fishd < 70) {
            boids[index].vx += (boids[index].x - fish.x) / 60000;
            boids[index].vy += (boids[index].y - fish.y) / 60000;
            }
        if (fishd <= 30) {
            boids[index].vx += (boids[index].x - fish.x) / 10000;
            boids[index].vy += (boids[index].y - fish.y) / 10000;
            }
        if(fishd <5){
            boids[index]　= {
                x: Math.random()*canvas.width, // x座標
                y: Math.random()*canvas.height, // y座標
                vx: (Math.random() * 4) - 2,                        // x方向の速度
                vy: (Math.random() * 4) - 2                         // y方向の速度
                }
            SCORE += 10;
            }
        }
    };
    
    
    /**
     * 2つのボイド間の距離
     */
    var getDistance = function(b1, b2) {
        var x = b1.x - b2.x;
        var y = b1.y - b2.y;
        return Math.sqrt(x*x + y*y);
        }
        
      /* タイムアップしたときの処理 */  
    var finish = function(){
        ctx.clearRect(0, 0, SCREEN_WIDTH, SCREEN_HEIGHT); // 画面をクリア

        // 全てのボイドの描画
        for (var i=0,len=boids.length; i<len; ++i) {
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.lineCap = "butt";
            ctx.moveTo(boids[i].x, boids[i].y);
            ctx.lineTo(boids[i].x+boids[i].vx*2, boids[i].y+boids[i].vy*2);
            ctx.stroke();
            
        }
            
            var rad = -Math.atan2(fish.vy,fish.vx)+ 90* Math.PI / 180;
            ctx.beginPath();
            ctx.lineWidth = 8;
            ctx.lineCap = "round";
            ctx.moveTo(fish.x, fish.y);
            ctx.lineTo(fish.x + 8*Math.cos(rad), fish.y + 8*Math.sin(rad));
            ctx.stroke();
        ctx.font = "40px Arial"; //フォントにArial,40px,斜体を指定
        ctx.fillStyle = "white"; //塗り潰し色を緑に
        ctx.textAlign = "center";
        ctx.fillText(text, SCREEN_WIDTH/2 , 100, 200 );
        document.getElementById("2").style.visibility = "visible";
        document.getElementById("3").style.visibility = "visible";
    };
    
    
    /* ボタンをタッチしたときの処理 */
    
    /* 続ける */
    function OnButtonClick() {
        time = 0;
        var main = setInterval(simulate, 1000/FPS);
        var fishmove = setInterval(fishm, 1000/FPS);
        document.getElementById("2").style.visibility = "hidden";
        document.getElementById("3").style.visibility = "hidden";
        };
        
        /* 最初から */
    function OnButtonClick1() {
        SCORE = 0;
        time = 30;
        var main = setInterval(simulate, 1000/FPS);
        var fishmove = setInterval(fishm, 1000/FPS);
        var count = setInterval(countdown, 100);
        setTimeout(function(){clearInterval(fishmove);}, time*1000);
        setTimeout(function(){clearInterval(main);}, time*1000);
        setTimeout(finish, time*1000);
        setTimeout(function(){clearInterval(count);}, time*1000);

        document.getElementById("2").style.visibility = "hidden";
        document.getElementById("3").style.visibility = "hidden";
        };
        
        
        
</script>
  </head>
  <body>
  <input class = "button1" type="button" value="最初から" id="2" onclick="OnButtonClick1()">
  <input class = "button1" type="button" value="続ける" id="3" onclick="OnButtonClick();">
  </body>
</html>

</html>

